<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>BitCrave | Staff Orders</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
  <style>
    body.dark-mode {
      background-color: #121212;
      color: #f0f0f0;
    }
    .table.dark-mode {
      background-color: #1e1e1e;
      color: #ffffff;
    }
    .navbar.dark-mode {
      background-color: #1e1e1e !important;
    }
    .badge-warning {
      background-color: #f0ad4e;
    }
  </style>
</head>
<body>

  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-primary px-4">
    <a class="navbar-brand" href="#">üçΩÔ∏è BitCrave - Staff Panel</a>
    <div class="ms-auto">
      <button class="btn btn-light btn-sm" id="darkModeToggle">üåô</button>
    </div>
  </nav>

  <!-- Main Content -->
  <div class="container mt-4">
    <h3 class="text-center mb-4">Confirmed Orders</h3>

    <table class="table table-bordered table-striped" id="orderTable">
      <thead class="table-dark">
        <tr>
          <th>#</th>
          <th>Name</th>
          <th>Date</th>
          <th>Time</th>
          <th>Guests</th>
          <th>Contact</th>
          <th>Order Details</th>
          <th>Total</th>
          <th>Payment Status</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody id="staffOrderTableBody">
        <!-- JS will populate this -->
      </tbody>
    </table>
  </div>

  <script>
    let reservations = JSON.parse(localStorage.getItem("bitcrave-reservations")) || [];
    const menu = JSON.parse(localStorage.getItem("bitcrave-menu")) || [];

    function calculateTotal(order = []) {
      return order.reduce((sum, itemName) => {
        const menuItem = menu.find(m => m.name === itemName);
        return sum + (menuItem ? Number(menuItem.price) : 0);
      }, 0);
    }

    function loadStaffOrders() {
      const tbody = document.getElementById("staffOrderTableBody");
      tbody.innerHTML = "";

      reservations.forEach((res, index) => {
        if (res.status === "Confirmed" && res.order && res.order.length) {
          const orderItems = res.order.map(item => item).join(", ");
          const total = calculateTotal(res.order);
          const paymentStatus = res.paymentStatus || "Pending";
          const badgeClass = paymentStatus === "Paid" ? "success" : "warning";

          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${index + 1}</td>
            <td>${res.name}</td>
            <td>${res.date}</td>
            <td>${res.time}</td>
            <td>${res.guests}</td>
            <td>${res.email}<br><small>${res.phone}</small></td>
            <td>${orderItems}</td>
            <td>‚Çπ${total}</td>
            <td><span class="badge bg-${badgeClass}">${paymentStatus}</span></td>
            <td>
              ${paymentStatus !== "Paid" ? `<button class="btn btn-sm btn-success" onclick="startPayment(${index})">Generate Bill & Pay</button>` : "-"}
            </td>
          `;
          tbody.appendChild(row);
        }
      });

      if (tbody.innerHTML.trim() === "") {
        tbody.innerHTML = `<tr><td colspan="10" class="text-center">No confirmed orders with items.</td></tr>`;
      }
    }

    function startPayment(index) {
      const booking = reservations[index];
      const total = calculateTotal(booking.order);

      const options = {
        key: "rzp_test_YourTestKeyHere",
        amount: total * 100,
        currency: "INR",
        name: "BitCrave",
        description: "Restaurant Order Payment",
        handler: function (response) {
          // Update payment status
          reservations[index].paymentStatus = "Paid";
          localStorage.setItem("bitcrave-reservations", JSON.stringify(reservations));

          // Store in bitcrave-payments
          const payments = JSON.parse(localStorage.getItem("bitcrave-payments")) || [];
          payments.push({
            paymentId: response.razorpay_payment_id,
            email: booking.email,
            amount: total,
            date: booking.date,
            time: booking.time,
            bookingId: index + 1,
            createdAt: new Date().toISOString()
          });
          localStorage.setItem("bitcrave-payments", JSON.stringify(payments));

          loadStaffOrders();
        },
        prefill: {
          name: booking.name,
          email: booking.email,
          contact: booking.phone
        },
        theme: {
          color: "#3399cc"
        }
      };
      const rzp = new Razorpay(options);
      rzp.open();
    }

    // Dark Mode Setup
    if (localStorage.getItem("bitcrave-theme") === "dark") {
      document.body.classList.add("dark-mode");
      document.querySelectorAll('.table, .navbar').forEach(el => el.classList.add('dark-mode'));
    }

    document.getElementById("darkModeToggle").addEventListener("click", () => {
      document.body.classList.toggle("dark-mode");
      document.querySelectorAll('.table, .navbar').forEach(el => el.classList.toggle('dark-mode'));
      const theme = document.body.classList.contains("dark-mode") ? "dark" : "light";
      localStorage.setItem("bitcrave-theme", theme);
    });

    window.onload = loadStaffOrders;
  </script>

</body>
</html>
