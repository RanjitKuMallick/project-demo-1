<!-- reservation.html - Admin Panel: Assign Table Number -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin - Reservations</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body.dark-mode {
      background-color: #121212;
      color: #f0f0f0;
    }
    .table.dark-mode {
      background-color: #1e1e1e;
      color: #ffffff;
    }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark px-4">
    <a class="navbar-brand" href="dashboard.html">‚Üê Back to Dashboard</a>
    <div class="ms-auto">
      <button class="btn btn-outline-light" id="darkModeToggle">üåô</button>
    </div>
  </nav>

  <div class="container mt-4">
    <h3>Table Reservations</h3>

    <table class="table table-bordered mt-4">
      <thead class="table-dark">
        <tr>
          <th>Name</th>
          <th>Date</th>
          <th>Time</th>
          <th>Guests</th>
          <th>Contact</th>
          <th>Status</th>
          <th>Table #</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody id="reservationTableBody">
        <!-- Filled dynamically -->
      </tbody>
    </table>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
  <script>
    emailjs.init("ci-JHDWo1WGRSl8OP");

    let reservations = JSON.parse(localStorage.getItem("bitcrave-reservations")) || [];

    function getAvailableTableNumbers() {
      const usedTables = reservations
        .filter(r => r.status === "Confirmed" && r.tableNumber)
        .map(r => r.tableNumber);
      const allTables = Array.from({ length: 10 }, (_, i) => i + 1); // 1 to 10
      return allTables.filter(t => !usedTables.includes(t));
    }

    function loadReservations() {
      const tbody = document.getElementById("reservationTableBody");
      tbody.innerHTML = "";

      reservations.forEach((r, index) => {
        const badgeClass = r.status === "Confirmed" ? "success"
                          : r.status === "Cancelled" ? "danger"
                          : "warning";
        const row = document.createElement("tr");

        row.innerHTML = `
          <td>${r.name}</td>
          <td>${r.date}</td>
          <td>${r.time}</td>
          <td>${r.guests}</td>
          <td>${r.email}<br><small>${r.phone}</small></td>
          <td><span class="badge bg-${badgeClass}">${r.status}</span></td>
          <td>${r.tableNumber || "-"}</td>
          <td>
            ${r.status === "Pending" ? `
              <select class="form-select form-select-sm mb-1" id="tableSelect-${index}">
                <option value="">Assign Table</option>
                ${getAvailableTableNumbers().map(num => `<option value="${num}">${num}</option>`).join("")}
              </select>
              <button class="btn btn-success btn-sm" onclick="confirmBooking(${index})">Confirm</button>
              <button class="btn btn-danger btn-sm mt-1" onclick="cancelBooking(${index})">Cancel</button>
            ` : ""}
          </td>
        `;
        tbody.appendChild(row);
      });
    }

    function confirmBooking(index) {
      const tableNo = document.getElementById(`tableSelect-${index}`).value;
      if (!tableNo) {
        alert("Please assign a table number first.");
        return;
      }

      reservations[index].status = "Confirmed";
      reservations[index].tableNumber = parseInt(tableNo);
      localStorage.setItem("bitcrave-reservations", JSON.stringify(reservations));
      loadReservations();

      const r = reservations[index];
      emailjs.send("service_xj1e9a6", "template_h9zgibs", {
        to_name: r.name,
        to_email: r.email,
        date: r.date,
        time: r.time,
        guests: r.guests,
        table: tableNo
      }).then(() => {
        console.log("Email sent.");
      }).catch(err => console.error("Email failed", err));
    }

    function cancelBooking(index) {
      reservations[index].status = "Cancelled";
      localStorage.setItem("bitcrave-reservations", JSON.stringify(reservations));
      loadReservations();
    }

    // Dark mode toggle
    if (localStorage.getItem("bitcrave-theme") === "dark") {
      document.body.classList.add("dark-mode");
      document.querySelectorAll('.table').forEach(el => el.classList.add('dark-mode'));
    }

    document.getElementById("darkModeToggle").addEventListener("click", () => {
      document.body.classList.toggle("dark-mode");
      document.querySelectorAll('.table').forEach(el => el.classList.toggle('dark-mode'));
      localStorage.setItem("bitcrave-theme", document.body.classList.contains("dark-mode") ? "dark" : "light");
    });

    window.onload = loadReservations;
  </script>
</body>
</html>
